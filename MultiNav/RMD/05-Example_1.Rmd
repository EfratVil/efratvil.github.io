# Example I - Dendrometer Sensors

The first example dataset corresponds to the challenge of identifying  malfunctioning dendrometer sensors with unsupervised anomaly detection methods. Dendrometers are measurement devices that can continuously monitor and record size variation in plant organs like stems, branches and fruits. Data from dendrometers can be used for monitoring of plants' daily water status, and accordingly make irrigation decisions. The challenge is to identify the malfunctioning sensors and filtering them out, before making irrigation decisions.

</br>
Loading the necessary packages:
```{r, message=FALSE, warning=FALSE}
library(MultiNav)
library(RColorBrewer)
library(data.table)

```

## Exploratory Data Anaylsis with First Order Scores
We start by loading the 'DendrometerSensors' dataset and performing initial exploration to get a feel of how the data looks like and to check if there are any sensors that have obvious anomalies. The dendrometer dataset includes data of 100 sensors from 120 hourly readings (5 days). The data is already pre-processed to ensure distributions are symmetric.


The exploration starts with a simple heatmap. It provides a quick view of the data. Some anomalies can be seen, but it is hard to understand the details. 


```{r ex1, message=FALSE, warning=FALSE}
data <- DendrometerSensors

cols <- rev(colorRampPalette(c("red", "white", "blue"))(100))
lattice::levelplot(as.matrix(data), col.regions = cols[length(cols):1],
                   ylab="Dendrometer Id",xlab="Hours")

```

Next we will explore the data with MultiNav. We do this by examining the data with the default first order scores that are calculated per sensor.

Hoovering over a point in one of the scores scatter plots, will automatically show highlighted the scores that the sensor received for all the other scoring methods and also will show the selected sensor values layed on top of a functional box plot. With this display, we can easily visually identify several anomalies (104, 142, 161, 182) and get an understanding of the nature of the anomaly.

```{r ex2, message=FALSE, warning=FALSE}

MultiNav(data,type = "snapshot scores")

```

</br></br>

## Evaluate Multivariate Scoring Methods
Next, several methods of multivariate anomaly scores will be calculated. At the first evaluation phase, it is not yet clear which of the methods is most suitable for this specific dataset (or combination of methods). We will evaluate and compare the scores with the "snapshot scores" display.

The anomaly scores will be calculated based on a time window of 72 hours. As pre-processing for this step, it is required to remove hours where the standard deviation equals 0 (which leaves 66 valid hours). The anomaly scores per sensor are calculated and stored in a data.table called Calculated.Scores, and passed to the MultiNav() function.

```{r e36, message=FALSE, warning=FALSE, error=FALSE, fig.height=5.5}
# We will examin anomalies in a window of last 72 hours.
mat<-data[49:120,]
# Excluding the hours with 0 sd (data remaining 66 hours).
exclude.hours<- c(1,24,25,48,49,72)
mat<-mat[-exclude.hours,]

set.seed(123)
T2 <- T2(t(mat))
T2_mcd75 <- T2_mcd75(t(mat))
T2_co <- round(T2_CrouxOllerer(t(mat)),5)
EigenCent<-EigenCentrality(mat)


Calculated.Scores <- as.data.table(cbind(id=as.numeric(colnames(mat)), T2=T2,T2_mcd75=T2_mcd75, T2_co=T2_co, EigenCent))
head(Calculated.Scores)

MultiNav(mat,type = "snapshot scores", scores = Calculated.Scores)

``` 
</br></br>


After visual examination of the anomaly scores, we can see:


+ There are some sensors that can be identified visually as anomaly by viewing the multivariate scores, but they were not detected by the univariate scores. For example sensor 150.

+ T2 score - as expected from a non robust anomaly score, this score does not seem to separate the anomalies as cleanly as the robust T2_MCD75. 

+ The T2_MCD75 score does a good job identifying most of the outliers, but may fail to recognize some outliers such as exhibited in sensor 104. 

+ EigenvectorCentrality score is good at capturing anit-correlation patterns, and works well in this use case as complimentary method to T2_MCD75. This method identified sensor 104 as outlier and also identified sensor 187 which were not identified with T2_MCD75.  

+ T2_co score was a good anomaly score candidate as it is both robust and adaptive for high dimensional data sets. However, in our specific use case where correlation levels are relatively high it does not seem to perform well. 


## Review Outliers
Next, we want to investigate anomalies found using our two selected anomaly methods: T2_MCD75 a robust multivariate anomaly score together with EigenvectorCentrality score. Our strategy is to use those scoring methods together. It is not necessary to exclude the sensors that were already identified as first order anomalies in the EDA phase, as those combined methods will also identify them. 

We will call again the "snapshot scores" display. But this time we will provide as input, a longer data stream containing data from 120 hours and ask to calculate rolling historical scores of a 66 hours window. We will also call the "mv" default scores set, which calculates both T2_MCD75 and EigenvectorCentrality scores.

```{r e4, message=FALSE, error=FALSE, warning=FALSE}

exclude.hours<- c(1,24,25,48,49,72,73,96,97,120)

MultiNav(data[-exclude.hours,],type = "snapshot scores", window=66, scores="mv")

``` 
</br></br>
Looking at the display, and hovering over a scatter plot point representing an anomalous sensor, we can further learn more about the strength and weakness of our two selected methods for identifying specific patterns of anomalies. 

In general, we can visually observe that the T2_mcd75 separates the anomalous sensors better than the EigenvectorCentrality method, but it misses some anomalous sensors such as 104, 187. 

To review the historical scores of a specific sensor, click on the sensor's point in one of the scores scatter plots. The displays updates, the focus moves to the selected sensor and the historical scores for the sensor are shown. This functionality enables to review if there is a trend of improvement or deterioration in the sensor's historical scores. 

